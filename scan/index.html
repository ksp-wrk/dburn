<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF417 Scanner</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --muted:#9fb0d0;
      --txt:#eaf0ff;
      --accent:#5eead4;
      --accent2:#60a5fa;
      --danger:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 55px rgba(0,0,0,.38);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1100px 650px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.18), transparent 55%),
        var(--bg);
      color:var(--txt);
    }
    header{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 10px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:8px 0 0;color:var(--muted);line-height:1.45;font-size:13px}
    main{max-width:1100px;margin:0 auto;padding:12px 16px 26px}
    .grid{
      display:grid;
      grid-template-columns:1.15fr .85fr;
      gap:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.02);
    }
    .card-head .h{font-weight:800;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      color:var(--bg);
      font-weight:800;
      border-color:transparent;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .card-body{padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="file"]{
      width:min(540px, 100%);
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--txt);
      cursor:pointer;
      transition:.15s transform ease, .15s background ease;
      font-weight:700;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    button.primary{
      border-color:transparent;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      color:var(--bg);
    }
    button.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
    button.small{padding:7px 10px;border-radius:10px;font-size:13px}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:13px;
    }
    .status.ok{border-color:rgba(94,234,212,.25);color:#c8fff3}
    .status.bad{border-color:rgba(251,113,133,.25);color:#ffdbe2}
    .preview{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#060a14;
    }
    #imgPreview,#video{
      display:block;
      width:100%;
      max-height:420px;
      object-fit:contain;
      background:#000;
    }
    textarea{
      width:100%;
      height:190px;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--txt);
      font-family:ui-monospace,Consolas,monospace;
      resize:vertical;
    }
    .history{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.02);
    }
    .item-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .meta{color:var(--muted);font-size:12px}
    .data{
      margin-top:8px;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,Consolas,monospace;
      font-size:12.8px;
      line-height:1.4;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      padding:10px;
      border-radius:12px;
    }
    footer{
      max-width:1100px;
      margin:0 auto;
      padding:10px 16px 22px;
      color:var(--muted);
      font-size:13px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .badge{
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    canvas{display:none}
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>PDF417 Scanner</h1>
        <div class="sub">Upload photo or use Live Camera. Results are stored locally in your browser (History).</div>
      </div>
      <div class="badge">WASM Decoder</div>
    </div>
  </header>

  <main>
    <div class="grid">

      <!-- Scanner -->
      <section class="card">
        <div class="card-head">
          <div class="h">Scanner</div>
          <div class="tabs">
            <div class="tab active" id="tabUpload">Upload</div>
            <div class="tab" id="tabLive">Live</div>
          </div>
        </div>

        <div class="card-body">
          <!-- Upload pane -->
          <div id="uploadPane">
            <div class="row">
              <input id="file" type="file" accept="image/*" />
              <button class="primary" id="decodeBtn">Decode</button>
              <button class="small" id="clearBtn">Clear</button>
            </div>

            <div class="status" id="status">Choose an image and click Decode.</div>

            <div class="preview" id="imgBox" style="display:none;">
              <img id="imgPreview" alt="preview" />
            </div>

            <textarea id="out" placeholder="Decoded text will appear here..."></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="small" id="copyBtn">Copy Result</button>
              <button class="small" id="saveBtn">Save to History</button>
            </div>
          </div>

          <!-- Live pane -->
          <div id="livePane" style="display:none;">
            <div class="row">
              <button class="primary" id="startCam">Start Camera</button>
              <button class="small" id="stopCam">Stop</button>
              <button class="small" id="torchBtn" title="If supported">Torch</button>
              <span class="badge">Scans every 400ms</span>
            </div>

            <div class="status" id="liveStatus">Click Start Camera and point at a PDF417 barcode.</div>

            <div class="preview">
              <video id="video" playsinline></video>
            </div>

            <textarea id="liveOut" placeholder="Live decoded text will appear here..."></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="small" id="liveCopyBtn">Copy Live Result</button>
              <button class="small" id="liveSaveBtn">Save to History</button>
            </div>

            <canvas id="cv"></canvas>
          </div>
        </div>
      </section>

      <!-- History -->
      <aside class="card">
        <div class="card-head">
          <div class="h">Stored Scans</div>
          <div class="row">
            <button class="small" id="exportJson">Export JSON</button>
            <button class="small" id="exportCsv">Export CSV</button>
            <button class="danger small" id="clearHistory">Clear</button>
          </div>
        </div>
        <div class="card-body">
          <div class="status" id="historyStatus">No scans yet.</div>
          <div class="history" id="history"></div>
        </div>
      </aside>

    </div>
  </main>

  <footer>
    <div>Developed by <strong>Khalid Saifullah</strong></div>
    <div><small>Tip: Crop barcode area, keep it sharp & well-lit for best decode.</small></div>
  </footer>

  <!-- ZXing C++ WASM (reader IIFE) -->
  <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2.2.4/dist/iife/reader/index.js"></script>

  <script>
    // ---------- Storage ----------
    const STORAGE_KEY = "pdf417_scans_v2";
    const loadHistory = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    };
    const saveHistory = (items) => localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

    // ---------- UI ----------
    const tabUpload = document.getElementById("tabUpload");
    const tabLive = document.getElementById("tabLive");
    const uploadPane = document.getElementById("uploadPane");
    const livePane = document.getElementById("livePane");

    const fileEl = document.getElementById("file");
    const imgBox = document.getElementById("imgBox");
    const imgPreview = document.getElementById("imgPreview");
    const statusEl = document.getElementById("status");
    const outEl = document.getElementById("out");
    const decodeBtn = document.getElementById("decodeBtn");
    const clearBtn = document.getElementById("clearBtn");
    const copyBtn = document.getElementById("copyBtn");
    const saveBtn = document.getElementById("saveBtn");

    const startCam = document.getElementById("startCam");
    const stopCam = document.getElementById("stopCam");
    const torchBtn = document.getElementById("torchBtn");
    const liveStatus = document.getElementById("liveStatus");
    const video = document.getElementById("video");
    const liveOut = document.getElementById("liveOut");
    const liveCopyBtn = document.getElementById("liveCopyBtn");
    const liveSaveBtn = document.getElementById("liveSaveBtn");
    const canvas = document.getElementById("cv");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    const historyEl = document.getElementById("history");
    const historyStatus = document.getElementById("historyStatus");
    const exportJson = document.getElementById("exportJson");
    const exportCsv = document.getElementById("exportCsv");
    const clearHistory = document.getElementById("clearHistory");

    let objectUrl = null;
    let scanning = false;
    let scanTimer = null;
    let lastLiveText = "";
    let streamTrack = null;

    function setStatus(el, msg, type="") {
      el.classList.remove("ok", "bad");
      if (type) el.classList.add(type);
      el.textContent = msg;
    }

    function switchTo(mode){
      if(mode === "upload"){
        tabUpload.classList.add("active");
        tabLive.classList.remove("active");
        uploadPane.style.display = "";
        livePane.style.display = "none";
        stopLive();
      } else {
        tabLive.classList.add("active");
        tabUpload.classList.remove("active");
        livePane.style.display = "";
        uploadPane.style.display = "none";
      }
    }
    tabUpload.onclick = () => switchTo("upload");
    tabLive.onclick = () => switchTo("live");

    // ---------- History render ----------
    function renderHistory(){
      const items = loadHistory();
      historyEl.innerHTML = "";
      if(!items.length){
        setStatus(historyStatus, "No scans yet.");
        return;
      }
      setStatus(historyStatus, `Stored: ${items.length} scan(s).`, "ok");

      items.slice().reverse().forEach((it, idxFromEnd) => {
        const idx = items.length - 1 - idxFromEnd;

        const div = document.createElement("div");
        div.className = "item";

        const top = document.createElement("div");
        top.className = "item-top";

        const left = document.createElement("div");
        left.innerHTML = `<div><strong>#${idx+1}</strong></div>
                          <div class="meta">${new Date(it.ts).toLocaleString()} • ${it.mode}</div>`;

        const right = document.createElement("div");
        right.className = "row";
        right.style.justifyContent = "flex-end";

        const btnCopy = document.createElement("button");
        btnCopy.className = "small";
        btnCopy.textContent = "Copy";
        btnCopy.onclick = async () => {
          await navigator.clipboard.writeText(it.text);
          setStatus(historyStatus, "Copied ✅", "ok");
        };

        const btnDel = document.createElement("button");
        btnDel.className = "danger small";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => {
          const all = loadHistory();
          all.splice(idx, 1);
          saveHistory(all);
          renderHistory();
        };

        right.append(btnCopy, btnDel);
        top.append(left, right);

        const data = document.createElement("div");
        data.className = "data";
        data.textContent = it.text;

        div.append(top, data);
        historyEl.append(div);
      });
    }

    function addToHistory(text, mode){
      const clean = (text || "").trim();
      if(!clean){
        setStatus(historyStatus, "Nothing to save (empty result).", "bad");
        return;
      }
      const items = loadHistory();
      items.push({ ts: Date.now(), mode, text: clean });
      saveHistory(items);
      renderHistory();
      setStatus(historyStatus, "Saved ✅", "ok");
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    exportJson.onclick = () => {
      const items = loadHistory();
      if(!items.length) return setStatus(historyStatus, "Nothing to export.", "bad");
      downloadFile("pdf417_scans.json", JSON.stringify(items, null, 2), "application/json");
      setStatus(historyStatus, "Exported JSON ✅", "ok");
    };

    exportCsv.onclick = () => {
      const items = loadHistory();
      if(!items.length) return setStatus(historyStatus, "Nothing to export.", "bad");
      const esc = (s) => `"${String(s).replace(/"/g,'""')}"`;
      const lines = ["timestamp,mode,text"].concat(
        items.map(it => `${esc(new Date(it.ts).toISOString())},${esc(it.mode)},${esc(it.text)}`)
      );
      downloadFile("pdf417_scans.csv", lines.join("\n"), "text/csv");
      setStatus(historyStatus, "Exported CSV ✅", "ok");
    };

    clearHistory.onclick = () => {
      if(!confirm("Clear all stored scans from this browser?")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      setStatus(historyStatus, "Cleared ✅", "ok");
    };

    // ---------- Decoder (WASM) ----------
    async function decodePDF417FromFile(file){
      // Read PDF417 only, tryHarder improves tough images
      const opts = {
        formats: ["PDF417"],
        tryHarder: true,
        maxNumberOfSymbols: 1
      };
      const results = await ZXingWASM.readBarcodes(file, opts);
      if(!results || !results.length) return null;
      return results[0].text || null;
    }

    async function decodePDF417FromImageData(imageData){
      const opts = {
        formats: ["PDF417"],
        tryHarder: true,
        maxNumberOfSymbols: 1
      };
      const results = await ZXingWASM.readBarcodes(imageData, opts);
      if(!results || !results.length) return null;
      return results[0].text || null;
    }

    // ---------- Upload mode ----------
    fileEl.addEventListener("change", () => {
      const f = fileEl.files?.[0];
      if(!f) return;

      if(objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(f);

      imgPreview.src = objectUrl;
      imgBox.style.display = "";
      outEl.value = "";
      setStatus(statusEl, "Image loaded. Click Decode.");
    });

    decodeBtn.addEventListener("click", async () => {
      const f = fileEl.files?.[0];
      if(!f){
        setStatus(statusEl, "Please choose an image first.", "bad");
        return;
      }
      try{
        setStatus(statusEl, "Decoding...", "ok");
        const text = await decodePDF417FromFile(f);
        if(!text){
          outEl.value = "";
          setStatus(statusEl, "Decode failed ❌ Try tighter crop / better lighting / sharper image.", "bad");
          return;
        }
        outEl.value = text;
        setStatus(statusEl, "Decoded successfully ✅", "ok");
      }catch(e){
        outEl.value = "";
        setStatus(statusEl, "Decoder error ❌ Try another image.", "bad");
      }
    });

    clearBtn.addEventListener("click", () => {
      if(objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = null;
      fileEl.value = "";
      imgPreview.src = "";
      imgBox.style.display = "none";
      outEl.value = "";
      setStatus(statusEl, "Choose an image and click Decode.");
    });

    copyBtn.addEventListener("click", async () => {
      const text = outEl.value.trim();
      if(!text) return setStatus(statusEl, "Nothing to copy.", "bad");
      await navigator.clipboard.writeText(text);
      setStatus(statusEl, "Copied ✅", "ok");
    });

    saveBtn.addEventListener("click", () => addToHistory(outEl.value, "upload"));

    // ---------- Live mode ----------
    async function startLive(){
      if(scanning) return;
      scanning = true;
      lastLiveText = "";
      liveOut.value = "";
      setStatus(liveStatus, "Starting camera...", "ok");

      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        await video.play();

        const tracks = stream.getVideoTracks();
        streamTrack = tracks?.[0] || null;

        setStatus(liveStatus, "Scanning... Point camera at PDF417.", "ok");

        // scan loop (every ~400ms)
        scanTimer = setInterval(async () => {
          if(!scanning) return;
          if(video.readyState < 2) return;

          // draw frame to canvas
          const w = video.videoWidth || 0;
          const h = video.videoHeight || 0;
          if(!w || !h) return;

          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);

          // (optional) speed: scale down huge frames
          // const scale = w > 1280 ? 1280 / w : 1;

          const imageData = ctx.getImageData(0, 0, w, h);

          try{
            const text = await decodePDF417FromImageData(imageData);
            if(text && text !== lastLiveText){
              lastLiveText = text;
              liveOut.value = text;
              setStatus(liveStatus, "Decoded ✅ (auto)", "ok");
            }
          }catch{
            // ignore frame errors
          }
        }, 400);

      }catch(e){
        scanning = false;
        setStatus(liveStatus, "Camera failed ❌ Allow camera permission / use HTTPS.", "bad");
      }
    }

    function stopLive(){
      scanning = false;
      if(scanTimer){ clearInterval(scanTimer); scanTimer = null; }

      const stream = video.srcObject;
      if(stream && stream.getTracks){
        stream.getTracks().forEach(t => t.stop());
      }
      video.srcObject = null;
      streamTrack = null;

      if(tabLive.classList.contains("active")){
        setStatus(liveStatus, "Stopped. Click Start Camera to scan again.");
      }
    }

    startCam.onclick = startLive;
    stopCam.onclick = stopLive;

    torchBtn.onclick = async () => {
      if(!streamTrack) return setStatus(liveStatus, "Torch not available.", "bad");
      const caps = streamTrack.getCapabilities?.();
      if(!caps || !caps.torch) return setStatus(liveStatus, "Torch not supported on this device/browser.", "bad");
      const settings = streamTrack.getSettings?.();
      const on = !!(settings && settings.torch);
      try{
        await streamTrack.applyConstraints({ advanced: [{ torch: !on }] });
        setStatus(liveStatus, `Torch: ${!on ? "ON" : "OFF"}`, "ok");
      }catch{
        setStatus(liveStatus, "Torch toggle failed.", "bad");
      }
    };

    liveCopyBtn.onclick = async () => {
      const text = liveOut.value.trim();
      if(!text) return setStatus(liveStatus, "Nothing to copy.", "bad");
      await navigator.clipboard.writeText(text);
      setStatus(liveStatus, "Copied ✅", "ok");
    };

    liveSaveBtn.onclick = () => addToHistory(liveOut.value, "live");

    // Init
    renderHistory();
    window.addEventListener("beforeunload", stopLive);
  </script>
</body>
</html>
