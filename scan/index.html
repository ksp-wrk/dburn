<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF417 Scanner</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a33; --muted:#9fb0d0; --txt:#eaf0ff;
      --accent:#5eead4; --accent2:#60a5fa; --danger:#fb7185; --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.18), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    header{
      padding:26px 18px 10px;
      max-width:1100px; margin:0 auto;
    }
    .title{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      color:var(--muted); font-size:12px; background:rgba(255,255,255,.02)
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    p.sub{margin:8px 0 0; color:var(--muted); line-height:1.5}
    main{max-width:1100px; margin:0 auto; padding:12px 18px 28px}
    .grid{
      display:grid; grid-template-columns: 1.15fr .85fr; gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .card-head .h{
      font-weight:650; letter-spacing:.2px;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      color:var(--bg);
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border-color:transparent;
      font-weight:650;
    }

    .card-body{padding:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type="file"]{
      border:1px dashed var(--border);
      padding:10px; border-radius:12px;
      background:rgba(255,255,255,.02);
      color:var(--muted);
      width:min(520px, 100%);
    }
    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform ease, .15s background ease;
    }
    button:hover{transform:translateY(-1px); background:rgba(255,255,255,.04)}
    button.primary{
      border-color:transparent;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      color:var(--bg);
      font-weight:700;
    }
    button.danger{border-color:rgba(251,113,133,.35); color:#ffdbe2}
    button.danger:hover{background:rgba(251,113,133,.12)}
    button.small{padding:7px 10px; border-radius:10px; font-size:13px}

    .status{
      margin-top:10px; color:var(--muted); font-size:13px;
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .status.ok{border-color:rgba(94,234,212,.25); color:#c8fff3}
    .status.bad{border-color:rgba(251,113,133,.25); color:#ffdbe2}

    .preview{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#060a14;
    }
    img#imgPreview{display:block; width:100%; max-height:420px; object-fit:contain}
    video#video{display:block; width:100%; max-height:420px; object-fit:cover; background:#000}
    textarea{
      width:100%;
      height:190px;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      resize:vertical;
    }

    .history{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.02);
    }
    .item-top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .meta{color:var(--muted); font-size:12px}
    .data{
      margin-top:8px;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12.8px;
      line-height:1.4;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      padding:10px; border-radius:12px;
    }
    footer{
      max-width:1100px; margin:0 auto;
      padding:10px 18px 22px;
      color:var(--muted);
      font-size:13px;
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }
    a{color:#b7d6ff; text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>PDF417 Scanner</h1>
      <span class="badge">Upload + Live Camera</span>
      <span class="badge">Local Storage History</span>
      <span class="badge">No Backend</span>
    </div>
    <p class="sub">
      Decode PDF417 barcodes from images or live camera. Scans are stored locally in your browser (localStorage).
      For best results: keep barcode sharp, well-lit, and fill the frame.
    </p>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Scanner -->
      <section class="card">
        <div class="card-head">
          <div class="h">Scanner</div>
          <div class="tabs">
            <div class="tab active" id="tabUpload">Upload</div>
            <div class="tab" id="tabLive">Live</div>
          </div>
        </div>

        <div class="card-body">
          <!-- Upload mode -->
          <div id="uploadPane">
            <div class="row">
              <input id="file" type="file" accept="image/*" />
              <button class="primary" id="decodeBtn">Decode</button>
              <button class="small" id="clearBtn">Clear</button>
            </div>

            <div class="status" id="status">Choose an image and click Decode.</div>

            <div class="preview" id="imgBox" style="display:none;">
              <img id="imgPreview" alt="preview" />
            </div>

            <textarea id="out" placeholder="Decoded text will appear here..."></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="small" id="copyBtn">Copy Result</button>
              <button class="small" id="saveBtn">Save to History</button>
            </div>
          </div>

          <!-- Live mode -->
          <div id="livePane" style="display:none;">
            <div class="row">
              <button class="primary" id="startCam">Start Camera</button>
              <button class="small" id="stopCam">Stop</button>
              <button class="small" id="toggleTorch" title="If supported">Torch</button>
              <span class="badge" id="camInfo">PDF417 only</span>
            </div>

            <div class="status" id="liveStatus">Click Start Camera and point at a PDF417 barcode.</div>

            <div class="preview">
              <video id="video" playsinline></video>
            </div>

            <textarea id="liveOut" placeholder="Live decoded text will appear here..."></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="small" id="liveCopyBtn">Copy Live Result</button>
              <button class="small" id="liveSaveBtn">Save to History</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: History -->
      <aside class="card">
        <div class="card-head">
          <div class="h">Stored Scans</div>
          <div class="row">
            <button class="small" id="exportJson">Export JSON</button>
            <button class="small" id="exportCsv">Export CSV</button>
            <button class="danger small" id="clearHistory">Clear</button>
          </div>
        </div>
        <div class="card-body">
          <div class="status" id="historyStatus">No scans yet.</div>
          <div class="history" id="history"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <div>Developed by <strong>Khalid Saifullah</strong></div>
    <div><small>Tip: Use a clear, high-resolution image or bring the barcode close to the camera.</small></div>
  </footer>

  <!-- ZXing: PDF417 decode in browser -->
  <script type="module">
    import {
      BrowserMultiFormatReader,
      BarcodeFormat,
      DecodeHintType
    } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/+esm";

    // ---------- State ----------
    const STORAGE_KEY = "pdf417_scans_v1";
    let objectUrl = null;
    let reader = null;
    let scanning = false;
    let lastLiveText = "";
    let currentStreamTrack = null;

    // ---------- Elements ----------
    const tabUpload = document.getElementById("tabUpload");
    const tabLive = document.getElementById("tabLive");
    const uploadPane = document.getElementById("uploadPane");
    const livePane = document.getElementById("livePane");

    const fileEl = document.getElementById("file");
    const imgBox = document.getElementById("imgBox");
    const imgPreview = document.getElementById("imgPreview");
    const statusEl = document.getElementById("status");
    const out = document.getElementById("out");
    const decodeBtn = document.getElementById("decodeBtn");
    const clearBtn = document.getElementById("clearBtn");
    const copyBtn = document.getElementById("copyBtn");
    const saveBtn = document.getElementById("saveBtn");

    const video = document.getElementById("video");
    const liveStatus = document.getElementById("liveStatus");
    const liveOut = document.getElementById("liveOut");
    const startCam = document.getElementById("startCam");
    const stopCam = document.getElementById("stopCam");
    const toggleTorch = document.getElementById("toggleTorch");
    const liveCopyBtn = document.getElementById("liveCopyBtn");
    const liveSaveBtn = document.getElementById("liveSaveBtn");

    const historyEl = document.getElementById("history");
    const historyStatus = document.getElementById("historyStatus");
    const exportJson = document.getElementById("exportJson");
    const exportCsv = document.getElementById("exportCsv");
    const clearHistory = document.getElementById("clearHistory");

    // ---------- Helpers ----------
    function setStatus(el, msg, type=""){
      el.textContent = msg;
      el.classList.remove("ok","bad");
      if(type) el.classList.add(type);
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch{
        return [];
      }
    }

    function saveHistory(items){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function renderHistory(){
      const items = loadHistory();
      historyEl.innerHTML = "";
      if(!items.length){
        setStatus(historyStatus, "No scans yet.");
        return;
      }
      setStatus(historyStatus, `Stored: ${items.length} scan(s).`, "ok");

      items.slice().reverse().forEach((it, idxFromEnd) => {
        const idx = items.length - 1 - idxFromEnd;

        const div = document.createElement("div");
        div.className = "item";

        const top = document.createElement("div");
        top.className = "item-top";

        const left = document.createElement("div");
        left.innerHTML = `<div><strong>#${idx+1}</strong></div><div class="meta">${new Date(it.ts).toLocaleString()} • ${it.mode}</div>`;

        const right = document.createElement("div");
        right.className = "row";
        right.style.justifyContent = "flex-end";

        const btnCopy = document.createElement("button");
        btnCopy.className = "small";
        btnCopy.textContent = "Copy";
        btnCopy.onclick = async () => {
          await navigator.clipboard.writeText(it.text);
          setStatus(historyStatus, "Copied ✅", "ok");
        };

        const btnDel = document.createElement("button");
        btnDel.className = "danger small";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => {
          const all = loadHistory();
          all.splice(idx, 1);
          saveHistory(all);
          renderHistory();
        };

        right.append(btnCopy, btnDel);
        top.append(left, right);

        const data = document.createElement("div");
        data.className = "data";
        data.textContent = it.text;

        div.append(top, data);
        historyEl.append(div);
      });
    }

    function addToHistory(text, mode){
      const clean = (text || "").trim();
      if(!clean){
        setStatus(historyStatus, "Nothing to save (empty result).", "bad");
        return;
      }
      const items = loadHistory();
      items.push({ ts: Date.now(), mode, text: clean });
      saveHistory(items);
      renderHistory();
      setStatus(historyStatus, "Saved ✅", "ok");
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- ZXing Reader ----------
    function makeReader(){
      const hints = new Map();
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.PDF_417]);
      // tryHarder helps with harder images, may cost CPU
      hints.set(DecodeHintType.TRY_HARDER, true);
      return new BrowserMultiFormatReader(hints, 500);
    }

    // ---------- Tabs ----------
    function switchTo(mode){
      if(mode === "upload"){
        tabUpload.classList.add("active");
        tabLive.classList.remove("active");
        uploadPane.style.display = "";
        livePane.style.display = "none";
        stopLive(); // stop camera if running
      }else{
        tabLive.classList.add("active");
        tabUpload.classList.remove("active");
        livePane.style.display = "";
        uploadPane.style.display = "none";
      }
    }

    tabUpload.onclick = () => switchTo("upload");
    tabLive.onclick = () => switchTo("live");

    // ---------- Upload mode ----------
    fileEl.addEventListener("change", () => {
      const f = fileEl.files?.[0];
      if(!f) return;
      if(objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(f);
      imgPreview.src = objectUrl;
      imgBox.style.display = "";
      out.value = "";
      setStatus(statusEl, "Image loaded. Click Decode.", "");
    });

    decodeBtn.addEventListener("click", async () => {
      if(!objectUrl){
        setStatus(statusEl, "Please choose an image first.", "bad");
        return;
      }
      if(!reader) reader = makeReader();

      try{
        setStatus(statusEl, "Decoding...", "ok");
        const result = await reader.decodeFromImageUrl(objectUrl);
        out.value = result.getText();
        setStatus(statusEl, "Decoded successfully ✅", "ok");
      }catch(e){
        out.value = "";
        setStatus(statusEl, "Decode failed ❌ Try clearer image / crop barcode / better lighting.", "bad");
      }finally{
        reader.reset();
      }
    });

    clearBtn.addEventListener("click", () => {
      if(objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = null;
      fileEl.value = "";
      imgPreview.src = "";
      imgBox.style.display = "none";
      out.value = "";
      setStatus(statusEl, "Choose an image and click Decode.", "");
    });

    copyBtn.addEventListener("click", async () => {
      const text = out.value.trim();
      if(!text) return setStatus(statusEl, "Nothing to copy.", "bad");
      await navigator.clipboard.writeText(text);
      setStatus(statusEl, "Copied ✅", "ok");
    });

    saveBtn.addEventListener("click", () => addToHistory(out.value, "upload"));

    // ---------- Live mode ----------
    async function startLive(){
      if(scanning) return;
      scanning = true;
      lastLiveText = "";
      liveOut.value = "";
      setStatus(liveStatus, "Starting camera...", "ok");

      if(!reader) reader = makeReader();

      try{
        // Prefer back camera
        const constraints = { video: { facingMode: "environment" }, audio: false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        // Keep a track reference for torch toggle
        const tracks = stream.getVideoTracks();
        currentStreamTrack = tracks?.[0] || null;

        setStatus(liveStatus, "Scanning... Point camera at PDF417.", "ok");

        // decode from video element
        reader.decodeFromVideoElementContinuously(video, (result, err) => {
          if(!scanning) return;
          if(result){
            const txt = result.getText();
            if(txt && txt !== lastLiveText){
              lastLiveText = txt;
              liveOut.value = txt;
              setStatus(liveStatus, "Decoded ✅ (auto-updating)", "ok");
            }
          }
        });

      }catch(e){
        scanning = false;
        setStatus(liveStatus, "Camera failed ❌ Allow camera permission / use HTTPS / try another browser.", "bad");
      }
    }

    function stopLive(){
      scanning = false;
      try{ reader?.reset(); }catch{}
      // stop camera stream
      const stream = video.srcObject;
      if(stream && stream.getTracks){
        stream.getTracks().forEach(t => t.stop());
      }
      video.srcObject = null;
      currentStreamTrack = null;
      setStatus(liveStatus, "Stopped. Click Start Camera to scan again.", "");
    }

    startCam.addEventListener("click", startLive);
    stopCam.addEventListener("click", stopLive);

    async function toggleTorchIfPossible(){
      if(!currentStreamTrack) return setStatus(liveStatus, "Torch not available.", "bad");
      const caps = currentStreamTrack.getCapabilities?.();
      if(!caps || !caps.torch) return setStatus(liveStatus, "Torch not supported on this device/browser.", "bad");
      const settings = currentStreamTrack.getSettings?.();
      const torchOn = settings && settings.torch;
      try{
        await currentStreamTrack.applyConstraints({ advanced: [{ torch: !torchOn }] });
        setStatus(liveStatus, `Torch: ${!torchOn ? "ON" : "OFF"}`, "ok");
      }catch{
        setStatus(liveStatus, "Torch toggle failed.", "bad");
      }
    }
    toggleTorch.addEventListener("click", toggleTorchIfPossible);

    liveCopyBtn.addEventListener("click", async () => {
      const text = liveOut.value.trim();
      if(!text) return setStatus(liveStatus, "Nothing to copy.", "bad");
      await navigator.clipboard.writeText(text);
      setStatus(liveStatus, "Copied ✅", "ok");
    });

    liveSaveBtn.addEventListener("click", () => addToHistory(liveOut.value, "live"));

    // ---------- Export / Clear ----------
    exportJson.addEventListener("click", () => {
      const items = loadHistory();
      if(!items.length) return setStatus(historyStatus, "Nothing to export.", "bad");
      downloadFile("pdf417_scans.json", JSON.stringify(items, null, 2), "application/json");
      setStatus(historyStatus, "Exported JSON ✅", "ok");
    });

    exportCsv.addEventListener("click", () => {
      const items = loadHistory();
      if(!items.length) return setStatus(historyStatus, "Nothing to export.", "bad");
      // Basic CSV with escaping
      const esc = (s) => `"${String(s).replace(/"/g,'""')}"`;
      const lines = ["timestamp,mode,text"].concat(
        items.map(it => `${esc(new Date(it.ts).toISOString())},${esc(it.mode)},${esc(it.text)}`)
      );
      downloadFile("pdf417_scans.csv", lines.join("\n"), "text/csv");
      setStatus(historyStatus, "Exported CSV ✅", "ok");
    });

    clearHistory.addEventListener("click", () => {
      if(!confirm("Clear all stored scans from this browser?")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      setStatus(historyStatus, "Cleared ✅", "ok");
    });

    // ---------- Init ----------
    renderHistory();
    // Ensure we stop camera if user leaves tab
    window.addEventListener("beforeunload", () => stopLive());
  </script>
</body>
</html>
